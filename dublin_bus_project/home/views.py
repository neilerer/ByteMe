from django.http import HttpResponse
from django.template import loader
from django.shortcuts import render
import json
import pickle as pkl
import os

def index(request): #called from home urls.py file

    # routes = ['00010001', '00010002', '00010003', '00011001', '00011002', '00040001', '00040002', '00041001','00041002', '00070001', '00070002', '00070003', '00070004', '00070005', '00071001', '00071002','00071003', '00071004', '00080001', '00081001', '00081002', '00090001', '00090002', '00091001','00091002', '00110001', '00110002', '00111001', '00111002', '00130001', '00130002', '00130003','00130004', '00130005', '00130006', '00130007', '00130008', '00131001', '00131002', '00131003','00131004', '00131005', '00131007', '00131008', '00131009', '00131010', '00131012', '00140001','00141001', '00141003', '00150001', '00150002', '00151001', '00151002', '00160001', '00160002','00160003', '00160004', '00161001', '00170001', '00170002', '00170003', '00170004', '00170005','00170006', '00171001', '00171002', '00171003', '00171004', '00180001', '00181001', '00181002','00250001', '00251001', '00260001', '00261001', '00270001', '00270002', '00270003', '00271001','00271002', '00271003', '00310001', '00310002', '00310003', '00311001', '00320001', '00321001','00330001', '00330002', '00330003', '00331001', '00331002', '00331004', '00331005', '00370001','00371001', '00371002', '00380001', '00380002', '00381001', '00381002', '00381003', '00390001','00390002', '00391001', '00400001', '00400002', '00400003', '00400004', '00401001', '00401002','00401003', '00410001', '00410003', '00410005', '00410006', '00410007', '00411001', '00411002','00411003', '00411004', '00420001', '00420002', '00421001', '00421002', '00430001', '00430002','00431001', '00431002', '00440001', '00440002', '00441001', '00441002', '00470001', '00470002','00470003', '00471001', '00471002', '00490001', '00491001', '00491002', '00530001', '00531001','00590001', '00591001', '00610001', '00610002', '00611001', '00611002', '00630001', '00630002','00630003', '00631001', '00631002', '00631003', '00631004', '00650001', '00650002', '00650003','00651001', '00651002', '00651003', '00660001', '00661001', '00670001', '00671001', '00680001','00680002', '00680003', '00680004', '00681001', '00681002', '00681003', '00681004', '00681005','00690001', '00691001', '00691002', '00700001', '00701001', '00750001', '00750002', '00751001','00751002', '00751003', '00751004', '00760001', '00761001', '00790001', '00791001', '007B0001','007B1001', '007D0001', '007D1001', '007D1002', '00830001', '00830003', '00830004', '00830006','00831001', '00831003', '00831004', '00831006', '00840001', '00840003', '00840004', '00841001','00841002', '00841004', '01020001', '01021001', '01021002', '01040001', '01041001', '01110001','01111001', '01140001', '01141001', '01160001', '01161001', '01161002', '01181001', '01200001','01200002', '01201001', '01201002', '01220001', '01220002', '01221001', '01221002', '01230001','01230002', '01231001', '01231002', '01300001', '01301001', '01400001', '01400002', '01401001','01401002', '01420001', '01421001', '01450001', '01450002', '01450003', '01450004', '01450005','01451001', '01451002', '01451003', '01451004', '01451005', '01451006', '01451007', '01451008','014C0001', '014C1001', '01500001', '01501001', '01501002', '01510001', '01510002', '01511001','01511002', '01511003', '015A0001', '015A0002', '015A1001', '015B0001', '015B0002', '015B0003','015B1001', '015B1002', '01610001', '01611001', '01611002', '016C0001', '016C0002', '016C0003','016C1001', '017A0001', '017A0002', '017A0004', '017A0005', '017A1001', '017A1002', '017A1003','017A1004', '01840001', '01841001', '01841002', '01850001', '01850002', '01850003', '01850004','01850005', '01850006', '01851001', '01851002', '01851003', '01851004', '01851005', '01851006','01851007', '01851008', '02200001', '02200002', '02201001', '02201002', '02360001', '02361001','02380001', '02380002', '02381001', '02390001', '02390002', '02391001', '025A0001', '025A1001','025B0001', '025B1001', '025X0001', '025X1001', '025X1002', '02700001', '02701001', '027A0001','027A1001', '027A1002', '027B0001', '027B0002', '027B0003', '027B0004', '027B0005', '027B1001','027B1002', '027B1003', '027B1004', '027B1005', '027B1006', '027X0001', '027X1001', '029A0001','029A1001', '031A0001', '031A1001', '031B0001', '031B0002', '031B0003', '031B1001', '031B1002','031B1003', '032A0001', '032A1001', '032B0001', '032B0002', '032B1001', '032B1002', '032X0001','032X1001', '032X1002', '033A0001', '033A0002', '033A1001', '033A1002', '033A1003', '033B0001','033B0002', '033B1001', '033B1002', '033B1003', '033X0001', '033X1001', '038A0001', '038A1001','038A1002', '038A1003', '038B0001', '038B1001', '039A0001', '039A0002', '039A1001', '039A1002','040B0001', '040B0002', '040B1001', '040D0001', '040D0002', '040D1001', '040D1002', '041A1001','041B0001', '041B0002', '041B1002', '041C0001', '041C1001', '041C1002', '041X0001', '041X0002','041X1001', '041X1002', '041X1003', '044B0001', '044B1001', '045A0001', '045A0003', '045A0004','045A1001', '045A1002', '045A1003', '045A1004', '045A1005', '046A0001', '046A0002', '046A0003','046A0004', '046A0005', '046A0007', '046A0008', '046A1001', '046A1002', '046A1003', '046A1004','046A1005', '046A1006', '046E1001', '051D0001', '051D1001', '051X1001', '053B0001', '053B1001','054A0001', '054A1001', '056A0001', '056A1001', '065B0001', '065B1001', '066A0001', '066A1001','066B0001', '066B1001', '066X0001', '066X0002', '066X0003', '066X0004', '066X1001', '066X1002','066X1003', '066X1004', '066X1005', '067X0001', '067X0002', '067X0003', '067X1001', '067X1002','068A0001', '068A1001', '069X0001', '069X1001', '07470001', '07471001', '076A0001', '076A1001','077A0001', '077A1001', '079A0001', '079A1001', '083A0001', '083A0002', '083A1001', '083A1002','084A0001', '084A0002', '084A1001', '084A1002', '084X0001', '084X0002', '084X1001', '084X1002','86-2', 'OL77X101', 'OL840013', 'PP071001']

    stops_00010001=['226', '228', '229', '227', '230', '231', '1641', '1642', '213', '214', '4432', '119', '44', '45', '46', '47', '48', '49', '50', '51', '52', '265', '271', '340', '350', '351', '352', '353', '354', '355', '356', '357', '390', '372', '373', '374', '375', '2804', '376', '377', '378', '380']
    context={'routes':['00010001'], 'stop_ids':stops_00010001} #homepage requires only the routes for the dropdown menu
    template = loader.get_template('home/index.html')  # loading the html homepage
    return HttpResponse(template.render(context, request)) #rendering routes to index.html

def get_route(request):
    if request.method=='GET': # getting form submission values from index.html
        selected_start=request.GET.get('start_point')
        selected_end = request.GET.get('end_point')
        selected_day = request.GET.get('weekday')
        selected_hour = request.GET.get('hour')

        # routes = ['00010001', '00010002', '00010003', '00011001', '00011002', '00040001', '00040002', '00041001','00041002', '00070001', '00070002', '00070003', '00070004', '00070005', '00071001', '00071002','00071003', '00071004', '00080001', '00081001', '00081002', '00090001', '00090002', '00091001','00091002', '00110001', '00110002', '00111001', '00111002', '00130001', '00130002', '00130003','00130004', '00130005', '00130006', '00130007', '00130008', '00131001', '00131002', '00131003','00131004', '00131005', '00131007', '00131008', '00131009', '00131010', '00131012', '00140001','00141001', '00141003', '00150001', '00150002', '00151001', '00151002', '00160001', '00160002','00160003', '00160004', '00161001', '00170001', '00170002', '00170003', '00170004', '00170005','00170006', '00171001', '00171002', '00171003', '00171004', '00180001', '00181001', '00181002','00250001', '00251001', '00260001', '00261001', '00270001', '00270002', '00270003', '00271001','00271002', '00271003', '00310001', '00310002', '00310003', '00311001', '00320001', '00321001','00330001', '00330002', '00330003', '00331001', '00331002', '00331004', '00331005', '00370001','00371001', '00371002', '00380001', '00380002', '00381001', '00381002', '00381003', '00390001','00390002', '00391001', '00400001', '00400002', '00400003', '00400004', '00401001', '00401002','00401003', '00410001', '00410003', '00410005', '00410006', '00410007', '00411001', '00411002','00411003', '00411004', '00420001', '00420002', '00421001', '00421002', '00430001', '00430002','00431001', '00431002', '00440001', '00440002', '00441001', '00441002', '00470001', '00470002','00470003', '00471001', '00471002', '00490001', '00491001', '00491002', '00530001', '00531001','00590001', '00591001', '00610001', '00610002', '00611001', '00611002', '00630001', '00630002','00630003', '00631001', '00631002', '00631003', '00631004', '00650001', '00650002', '00650003','00651001', '00651002', '00651003', '00660001', '00661001', '00670001', '00671001', '00680001','00680002', '00680003', '00680004', '00681001', '00681002', '00681003', '00681004', '00681005','00690001', '00691001', '00691002', '00700001', '00701001', '00750001', '00750002', '00751001','00751002', '00751003', '00751004', '00760001', '00761001', '00790001', '00791001', '007B0001','007B1001', '007D0001', '007D1001', '007D1002', '00830001', '00830003', '00830004', '00830006','00831001', '00831003', '00831004', '00831006', '00840001', '00840003', '00840004', '00841001','00841002', '00841004', '01020001', '01021001', '01021002', '01040001', '01041001', '01110001','01111001', '01140001', '01141001', '01160001', '01161001', '01161002', '01181001', '01200001','01200002', '01201001', '01201002', '01220001', '01220002', '01221001', '01221002', '01230001','01230002', '01231001', '01231002', '01300001', '01301001', '01400001', '01400002', '01401001','01401002', '01420001', '01421001', '01450001', '01450002', '01450003', '01450004', '01450005','01451001', '01451002', '01451003', '01451004', '01451005', '01451006', '01451007', '01451008','014C0001', '014C1001', '01500001', '01501001', '01501002', '01510001', '01510002', '01511001','01511002', '01511003', '015A0001', '015A0002', '015A1001', '015B0001', '015B0002', '015B0003','015B1001', '015B1002', '01610001', '01611001', '01611002', '016C0001', '016C0002', '016C0003','016C1001', '017A0001', '017A0002', '017A0004', '017A0005', '017A1001', '017A1002', '017A1003','017A1004', '01840001', '01841001', '01841002', '01850001', '01850002', '01850003', '01850004','01850005', '01850006', '01851001', '01851002', '01851003', '01851004', '01851005', '01851006','01851007', '01851008', '02200001', '02200002', '02201001', '02201002', '02360001', '02361001','02380001', '02380002', '02381001', '02390001', '02390002', '02391001', '025A0001', '025A1001','025B0001', '025B1001', '025X0001', '025X1001', '025X1002', '02700001', '02701001', '027A0001','027A1001', '027A1002', '027B0001', '027B0002', '027B0003', '027B0004', '027B0005', '027B1001','027B1002', '027B1003', '027B1004', '027B1005', '027B1006', '027X0001', '027X1001', '029A0001','029A1001', '031A0001', '031A1001', '031B0001', '031B0002', '031B0003', '031B1001', '031B1002','031B1003', '032A0001', '032A1001', '032B0001', '032B0002', '032B1001', '032B1002', '032X0001','032X1001', '032X1002', '033A0001', '033A0002', '033A1001', '033A1002', '033A1003', '033B0001','033B0002', '033B1001', '033B1002', '033B1003', '033X0001', '033X1001', '038A0001', '038A1001','038A1002', '038A1003', '038B0001', '038B1001', '039A0001', '039A0002', '039A1001', '039A1002','040B0001', '040B0002', '040B1001', '040D0001', '040D0002', '040D1001', '040D1002', '041A1001','041B0001', '041B0002', '041B1002', '041C0001', '041C1001', '041C1002', '041X0001', '041X0002','041X1001', '041X1002', '041X1003', '044B0001', '044B1001', '045A0001', '045A0003', '045A0004','045A1001', '045A1002', '045A1003', '045A1004', '045A1005', '046A0001', '046A0002', '046A0003','046A0004', '046A0005', '046A0007', '046A0008', '046A1001', '046A1002', '046A1003', '046A1004','046A1005', '046A1006', '046E1001', '051D0001', '051D1001', '051X1001', '053B0001', '053B1001','054A0001', '054A1001', '056A0001', '056A1001', '065B0001', '065B1001', '066A0001', '066A1001','066B0001', '066B1001', '066X0001', '066X0002', '066X0003', '066X0004', '066X1001', '066X1002','066X1003', '066X1004', '066X1005', '067X0001', '067X0002', '067X0003', '067X1001', '067X1002','068A0001', '068A1001', '069X0001', '069X1001', '07470001', '07471001', '076A0001', '076A1001','077A0001', '077A1001', '079A0001', '079A1001', '083A0001', '083A0002', '083A1001', '083A1002','084A0001', '084A0002', '084A1001', '084A1002', '084X0001', '084X0002', '084X1001', '084X1002','86-2', 'OL77X101', 'OL840013', 'PP071001']
        routes=['00010001']
        # with open("home/stops_on_routes.json") as route_file: #reading dictionary {key:value} = {stop:[routes]}
        #     stops_on_routes = json.load(route_file)
        stops_on_routes=['226', '228', '229', '227', '230', '231', '1641', '1642', '213', '214', '4432', '119', '44', '45', '46', '47', '48', '49', '50', '51', '52', '265', '271', '340', '350', '351', '352', '353', '354', '355', '356', '357', '390', '372', '373', '374', '375', '2804', '376', '377', '378', '380']
        for i in range(len(stops_on_routes)):
            stops_on_routes[i]=int(stops_on_routes[i])
        # with open("home/jpids_and_stops.json") as route_file: #reading dictionary {key:value} = {stop:[routes]}
        #     stops_on_routes = json.load(route_file)
        with open("home/stop_coordinates.json") as stop_file: #reading dictionary {key:value} = {stop:[lat,long]}
            stop_coordinates = json.load(stop_file)
            selected_route='00010001'

        with open("../00010001_pickles/00010001-"+selected_end+".pkl", "rb") as input_file:
            end_data = pkl.load(input_file)
            end_query_data = {'Mon': [0], 'Tue': [0], 'Wed': [0], 'Thu': [0], 'Fri': [0], 'Sat': [0], 'Sun': [0],
                         'h7': [0], 'h8': [0], 'h9': [0], 'h10': [0], 'h11': [0], 'h12': [0], 'h13': [0], 'h14': [0],'h15': [0],
                         'h16': [0], 'h17': [0], 'h18': [0], 'h19': [0], 'h20': [0], 'h21': [0], 'h22': [0], 'h23': [0]}
            days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun']
            end_query_data[days[int(selected_day)]][0],end_query_data["h"+selected_hour][0]=1,1
            end_time=end_data.predict(end_query_data)[0]

        with open("../00010001_pickles/00010001-" + selected_start + ".pkl", "rb") as input_file:
            start_data = pkl.load(input_file)
            start_query_data = {'Mon': [0], 'Tue': [0], 'Wed': [0], 'Thu': [0], 'Fri': [0], 'Sat': [0], 'Sun': [0],
                              'h7': [0], 'h8': [0], 'h9': [0], 'h10': [0], 'h11': [0], 'h12': [0], 'h13': [0],
                              'h14': [0], 'h15': [0],
                              'h16': [0], 'h17': [0], 'h18': [0], 'h19': [0], 'h20': [0], 'h21': [0], 'h22': [0],
                              'h23': [0]}
            start_query_data[days[int(selected_day)]][0], start_query_data["h" + selected_hour][0] = 1, 1
            start_time = start_data.predict(start_query_data)[0]
        journey_time=int(end_time-start_time)//60

        returned_stops=[] # list of routes to return on the map
        for i in range(stops_on_routes.index(int(selected_start)),stops_on_routes.index(int(selected_end))+1):
            returned_stops.append(stops_on_routes[i])

        stops_00010001=['226', '228', '229', '227', '230', '231', '1641', '1642', '213', '214', '4432', '119', '44', '45', '46', '47', '48', '49', '50', '51', '52', '265', '271', '340', '350', '351', '352', '353', '354', '355', '356', '357', '390', '372', '373', '374', '375', '2804', '376', '377', '378', '380']
        context = {'stop_ids':stops_00010001,'stops_on_routes': returned_stops, 'routes': routes, 'stop_coordinates': stop_coordinates, 'selected_route':selected_route,'journey_time':journey_time,'selected_start':selected_start,'selected_end':selected_end }
        template = loader.get_template('home/index.html')
        return HttpResponse(template.render(context, request))

